name: Java CI/CD - SonarQube, Nexus, Tomcat

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:   # allows manual run from Actions tab

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      NEXUS_URL: http://18.226.34.227:8081
      NEXUS_REPO: maven-releases
      NEXUS_GROUP: com/web/cal
      NEXUS_ARTIFACT: webapp-add
      TOMCAT_URL: http://18.216.0.11:8080/manager/text

    steps:
    - name: üì¶ Checkout Code
      uses: actions/checkout@v4

    - name: ‚òï Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: üß∞ Cache Maven Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: üîç Run SonarQube Analysis
      run: |
        mvn clean verify sonar:sonar \
          -DskipTests \
          -Dsonar.projectKey=JavaWebCalculator \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}

    - name: ‚öôÔ∏è Build WAR File
      run: |
        mvn clean package -DskipTests
        echo "‚úÖ Build completed!"
        ls -lh target/*.war

    - name: ‚¨ÜÔ∏è Upload Artifact to Nexus
      env:
        NEXUS_USER: ${{ secrets.NEXUS_USER }}
        NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
      run: |
        set -e
        WAR_FILE=$(ls target/*.war | head -1)
        FILE_NAME=$(basename "$WAR_FILE")
        VERSION="0.0.${{ github.run_number }}"
        echo "üì§ Uploading $FILE_NAME to Nexus as version $VERSION..."
        curl -u ${NEXUS_USER}:${NEXUS_PASS} --upload-file "$WAR_FILE" \
          "${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/${{ env.NEXUS_GROUP }}/${{ env.NEXUS_ARTIFACT }}/${VERSION}/${{ env.NEXUS_ARTIFACT }}-${VERSION}.war"
        echo "‚úÖ Artifact uploaded successfully to Nexus!"

    - name: üöÄ Deploy WAR to Tomcat
      env:
        TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
        TOMCAT_PASS: ${{ secrets.TOMCAT_PASS }}
        NEXUS_USER: ${{ secrets.NEXUS_USER }}
        NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
      run: |
        set -e
        cd /tmp; rm -f *.war

        echo "üîç Fetching latest WAR from Nexus..."
        DOWNLOAD_URL=$(curl -s -u ${NEXUS_USER}:${NEXUS_PASS} \
          "${{ env.NEXUS_URL }}/service/rest/v1/search/assets?repository=${{ env.NEXUS_REPO }}" \
          | grep -oP '"downloadUrl"\s*:\s*"[^"]*webapp-add-[0-9.]+\.war' | tail -1 | cut -d'"' -f4)

        if [[ -z "$DOWNLOAD_URL" ]]; then
          echo "‚ùå No WAR found in Nexus!"
          exit 1
        fi

        echo "‚¨áÔ∏è Downloading WAR: $DOWNLOAD_URL"
        curl -u ${NEXUS_USER}:${NEXUS_PASS} -O "$DOWNLOAD_URL"
        WAR_FILE=$(basename "$DOWNLOAD_URL")
        APP_NAME=$(echo "$WAR_FILE" | sed 's/-[0-9].*//')

        echo "üßπ Removing old deployment..."
        curl -u ${TOMCAT_USER}:${TOMCAT_PASS} "${{ env.TOMCAT_URL }}/undeploy?path=/${APP_NAME}" || true

        echo "üöÄ Deploying new WAR to Tomcat..."
        curl -u ${TOMCAT_USER}:${TOMCAT_PASS} --upload-file "$WAR_FILE" \
          "${{ env.TOMCAT_URL }}/deploy?path=/${APP_NAME}&update=true"

        echo "‚úÖ Deployment successful! Application updated."

    - name: üîé Verify Deployment
      run: |
        sleep 10
        STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://18.216.0.11:8080/webapp-add/)
        if [ "$STATUS" -eq 200 ]; then
          echo "‚úÖ App is live and updated!"
        else
          echo "‚ö†Ô∏è App returned status $STATUS"
          exit 1
        fi
